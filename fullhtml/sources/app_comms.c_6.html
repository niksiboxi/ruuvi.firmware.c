
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_comms.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;app_config.h&quot;</a>
<a name="ln2">#include &quot;app_comms.h&quot;</a>
<a name="ln3">#include &quot;app_heartbeat.h&quot;</a>
<a name="ln4">#include &quot;app_led.h&quot;</a>
<a name="ln5">#include &quot;app_sensor.h&quot;</a>
<a name="ln6">#include &quot;ruuvi_boards.h&quot;</a>
<a name="ln7">#include &quot;ruuvi_endpoints.h&quot;</a>
<a name="ln8">#include &quot;ruuvi_interface_communication.h&quot;</a>
<a name="ln9">#include &quot;ruuvi_interface_communication_radio.h&quot;</a>
<a name="ln10">#include &quot;ruuvi_interface_rtc.h&quot;</a>
<a name="ln11">#include &quot;ruuvi_interface_scheduler.h&quot;</a>
<a name="ln12">#include &quot;ruuvi_interface_timer.h&quot;</a>
<a name="ln13">#include &quot;ruuvi_interface_yield.h&quot;</a>
<a name="ln14">#include &quot;ruuvi_task_advertisement.h&quot;</a>
<a name="ln15">#include &quot;ruuvi_task_communication.h&quot;</a>
<a name="ln16">#include &quot;ruuvi_task_gatt.h&quot;</a>
<a name="ln17">#include &quot;ruuvi_task_nfc.h&quot;</a>
<a name="ln18">#include &lt;stdio.h&gt;</a>
<a name="ln19">#include &lt;string.h&gt;</a>
<a name="ln20"> </a>
<a name="ln21">/**</a>
<a name="ln22"> * @addtogroup app_comms</a>
<a name="ln23"> */</a>
<a name="ln24">/** @{ */</a>
<a name="ln25">/**</a>
<a name="ln26"> * @file app_comms.c</a>
<a name="ln27"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln28"> * @date 2020-09-10</a>
<a name="ln29"> * @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln30"> *</a>
<a name="ln31"> * Typical usage:</a>
<a name="ln32"> * @code{.c}</a>
<a name="ln33"> * TODO</a>
<a name="ln34"> * @endcode</a>
<a name="ln35"> */</a>
<a name="ln36"> </a>
<a name="ln37">/** @brief Set to long enough to handle existing queue, then as short as possible. */</a>
<a name="ln38">#define BLOCKING_COMM_TIMEOUT_MS (2000U)</a>
<a name="ln39"> </a>
<a name="ln40">#if APP_COMMS_BIDIR_ENABLED</a>
<a name="ln41">#ifndef CEEDLING</a>
<a name="ln42">static</a>
<a name="ln43">#endif</a>
<a name="ln44">bool m_config_enabled_on_curr_conn; //!&lt; This connection has config enabled.</a>
<a name="ln45">#ifndef CEEDLING</a>
<a name="ln46">static</a>
<a name="ln47">#endif</a>
<a name="ln48">bool m_config_enabled_on_next_conn;    //!&lt; Next connection has config enabled.</a>
<a name="ln49">#endif</a>
<a name="ln50"> </a>
<a name="ln51">#ifndef CEEDLING</a>
<a name="ln52">typedef struct</a>
<a name="ln53">{</a>
<a name="ln54">    unsigned int switch_to_normal : 1; //!&lt; Stop initial fast advertising.</a>
<a name="ln55">    unsigned int disable_config : 1;   //!&lt; Disable configuration mode.</a>
<a name="ln56">} mode_changes_t;</a>
<a name="ln57">#endif</a>
<a name="ln58"> </a>
<a name="ln59">static uint8_t m_bleadv_repeat_count; //!&lt; Number of times to repeat advertisement.</a>
<a name="ln60"> </a>
<a name="ln61">#ifndef CEEDLING</a>
<a name="ln62">static</a>
<a name="ln63">#endif</a>
<a name="ln64">ri_timer_id_t m_comm_timer;    //!&lt; Timer for communication mode changes.</a>
<a name="ln65"> </a>
<a name="ln66">#ifndef CEEDLING</a>
<a name="ln67">static</a>
<a name="ln68">#endif</a>
<a name="ln69">mode_changes_t m_mode_ops;     //!&lt; Pending mode changes.</a>
<a name="ln70"> </a>
<a name="ln71">uint8_t app_comms_bleadv_send_count_get (void)</a>
<a name="ln72">{</a>
<a name="ln73">    return m_bleadv_repeat_count;</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76">void app_comms_bleadv_send_count_set (const uint8_t count)</a>
<a name="ln77">{</a>
<a name="ln78">    m_bleadv_repeat_count = count;</a>
<a name="ln79">}</a>
<a name="ln80"> </a>
<a name="ln81">/**</a>
<a name="ln82"> * @brief Start a timer for switching over to normal mode.</a>
<a name="ln83"> */</a>
<a name="ln84">static rd_status_t timed_switch_to_normal_mode (void)</a>
<a name="ln85">{</a>
<a name="ln86">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln87">    m_mode_ops.switch_to_normal = 1;</a>
<a name="ln88">    err_code |= ri_timer_stop (m_comm_timer);</a>
<a name="ln89">    err_code |= ri_timer_start (m_comm_timer, APP_FAST_ADV_TIME_MS, &amp;m_mode_ops);</a>
<a name="ln90">    return err_code;</a>
<a name="ln91">}</a>
<a name="ln92"> </a>
<a name="ln93">static rd_status_t prepare_mode_change (const mode_changes_t * p_change)</a>
<a name="ln94">{</a>
<a name="ln95">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln96"> </a>
<a name="ln97">    if (p_change-&gt;switch_to_normal)</a>
<a name="ln98">    {</a>
<a name="ln99">        err_code |= timed_switch_to_normal_mode();</a>
<a name="ln100">    }</a>
<a name="ln101"> </a>
<a name="ln102">    return err_code;</a>
<a name="ln103">}</a>
<a name="ln104"> </a>
<a name="ln105">/**</a>
<a name="ln106"> * @brief Calculate how many times advertisements must be repeated</a>
<a name="ln107"> *        to send at the initial fast rate.</a>
<a name="ln108"> */</a>
<a name="ln109">static uint8_t initial_adv_send_count (void)</a>
<a name="ln110">{</a>
<a name="ln111">    uint8_t num_sends = (APP_HEARTBEAT_INTERVAL_MS / 100U);</a>
<a name="ln112"> </a>
<a name="ln113">    if (0 == num_sends)</a>
<a name="ln114">    {</a>
<a name="ln115">        num_sends = 1;</a>
<a name="ln116">    }</a>
<a name="ln117"> </a>
<a name="ln118">    if (APP_COMM_ADV_REPEAT_FOREVER == num_sends)</a>
<a name="ln119">    {</a>
<a name="ln120">        num_sends = APP_COMM_ADV_REPEAT_FOREVER - 1;</a>
<a name="ln121">    }</a>
<a name="ln122"> </a>
<a name="ln123">    return num_sends;</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126">#if APP_COMMS_BIDIR_ENABLED</a>
<a name="ln127">/**</a>
<a name="ln128"> * @brief Allow configuration commands on next connection.</a>
<a name="ln129"> *</a>
<a name="ln130"> * @param[in] enable True to enable configuration on connection, false to disable.</a>
<a name="ln131"> */</a>
<a name="ln132">static rd_status_t enable_config_on_next_conn (const bool enable)</a>
<a name="ln133">{</a>
<a name="ln134">    m_config_enabled_on_next_conn = enable;</a>
<a name="ln135">    return RD_SUCCESS;</a>
<a name="ln136">}</a>
<a name="ln137"> </a>
<a name="ln138">/**</a>
<a name="ln139"> * @brief Enable configuration on this connection if appropriate.</a>
<a name="ln140"> *</a>
<a name="ln141"> * This function should be called on connection established interrupt.</a>
<a name="ln142"> * After calling this function, next connection will not be configurable</a>
<a name="ln143"> * unless @ref enable_config_on_next_conn is called with true.</a>
<a name="ln144"> *</a>
<a name="ln145"> * @retval RD_SUCCESS Always.</a>
<a name="ln146"> */</a>
<a name="ln147">static rd_status_t config_setup_on_this_conn (void)</a>
<a name="ln148">{</a>
<a name="ln149">    m_config_enabled_on_curr_conn = m_config_enabled_on_next_conn;</a>
<a name="ln150">    m_config_enabled_on_next_conn = false;</a>
<a name="ln151">    m_mode_ops.switch_to_normal = 0;</a>
<a name="ln152">    return RD_SUCCESS;</a>
<a name="ln153">}</a>
<a name="ln154"> </a>
<a name="ln155">/**</a>
<a name="ln156"> * @brief Cleanup connection configuration.</a>
<a name="ln157"> *</a>
<a name="ln158"> * This function should be called on connection lost interrupt.</a>
<a name="ln159"> *</a>
<a name="ln160"> * @retval RD_SUCCESS Always.</a>
<a name="ln161"> */</a>
<a name="ln162">static rd_status_t config_conn_end (void)</a>
<a name="ln163">{</a>
<a name="ln164">    m_config_enabled_on_curr_conn = false;</a>
<a name="ln165">    return RD_SUCCESS;</a>
<a name="ln166">}</a>
<a name="ln167"> </a>
<a name="ln168">static void handle_comms (const ri_comm_xfer_fp_t reply_fp, void * p_data,</a>
<a name="ln169">                          size_t data_len)</a>
<a name="ln170">{</a>
<a name="ln171">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln172"> </a>
<a name="ln173">    if (NULL == p_data)</a>
<a name="ln174">    {</a>
<a name="ln175">        err_code |= RD_ERROR_NULL;</a>
<a name="ln176">    }</a>
<a name="ln177">    else if (data_len &lt; RE_STANDARD_MESSAGE_LENGTH)</a>
<a name="ln178">    {</a>
<a name="ln179">        err_code |= RD_ERROR_INVALID_PARAM;</a>
<a name="ln180">    }</a>
<a name="ln181">    else</a>
<a name="ln182">    {</a>
<a name="ln183">        // Stop heartbeat processing.</a>
<a name="ln184">        err_code |= app_heartbeat_stop();</a>
<a name="ln185">        // Parse message type</a>
<a name="ln186">        const uint8_t * const raw_message = (uint8_t *) p_data;</a>
<a name="ln187">        re_type_t type = raw_message[RE_STANDARD_DESTINATION_INDEX];</a>
<a name="ln188"> </a>
<a name="ln189">        // Route message to proper handler</a>
<a name="ln190">        switch (type)</a>
<a name="ln191">        {</a>
<a name="ln192">            case RE_ACC_XYZ:</a>
<a name="ln193">            case RE_ACC_X:</a>
<a name="ln194">            case RE_ACC_Y:</a>
<a name="ln195">            case RE_ACC_Z:</a>
<a name="ln196">            case RE_GYR_XYZ:</a>
<a name="ln197">            case RE_GYR_X:</a>
<a name="ln198">            case RE_GYR_Y:</a>
<a name="ln199">            case RE_GYR_Z:</a>
<a name="ln200">            case RE_ENV_ALL:</a>
<a name="ln201">            case RE_ENV_TEMP:</a>
<a name="ln202">            case RE_ENV_HUMI:</a>
<a name="ln203">            case RE_ENV_PRES:</a>
<a name="ln204">                err_code |= app_sensor_handle (reply_fp, raw_message, data_len);</a>
<a name="ln205">                break;</a>
<a name="ln206"> </a>
<a name="ln207">            default:</a>
<a name="ln208">                break;</a>
<a name="ln209">        }</a>
<a name="ln210"> </a>
<a name="ln211">        // Resume heartbeat processing.</a>
<a name="ln212">        err_code |= app_heartbeat_start();</a>
<a name="ln213">    }</a>
<a name="ln214"> </a>
<a name="ln215">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln216">}</a>
<a name="ln217"> </a>
<a name="ln218">#if APP_GATT_ENABLED</a>
<a name="ln219"> </a>
<a name="ln220">#ifndef CEEDLING</a>
<a name="ln221">static</a>
<a name="ln222">#endif</a>
<a name="ln223">void handle_gatt_data (void * p_data, uint16_t data_len)</a>
<a name="ln224">{</a>
<a name="ln225">    handle_comms (&amp;rt_gatt_send_asynchronous, p_data, data_len);</a>
<a name="ln226">}</a>
<a name="ln227"> </a>
<a name="ln228">#ifndef CEEDLING</a>
<a name="ln229">static</a>
<a name="ln230">#endif</a>
<a name="ln231">void handle_gatt_connected (void * p_data, uint16_t data_len)</a>
<a name="ln232">{</a>
<a name="ln233">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln234">    rt_gatt_disable ();</a>
<a name="ln235">    config_setup_on_this_conn ();</a>
<a name="ln236">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln237">}</a>
<a name="ln238"> </a>
<a name="ln239">/** @brief Callback when GATT is connected&quot; */</a>
<a name="ln240">#ifndef CEEDLING</a>
<a name="ln241">static</a>
<a name="ln242">#endif</a>
<a name="ln243">void on_gatt_connected_isr (void * p_data, size_t data_len)</a>
<a name="ln244">{</a>
<a name="ln245">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln246">    err_code |= ri_scheduler_event_put (p_data, (uint16_t) data_len,</a>
<a name="ln247">                                        &amp;handle_gatt_connected);</a>
<a name="ln248">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln249">}</a>
<a name="ln250"> </a>
<a name="ln251">#ifndef CEEDLING</a>
<a name="ln252">static</a>
<a name="ln253">#endif</a>
<a name="ln254">void handle_gatt_disconnected (void * p_data, uint16_t data_len)</a>
<a name="ln255">{</a>
<a name="ln256">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln257">    err_code |= config_conn_end();</a>
<a name="ln258">    err_code |= app_led_activity_set (RB_LED_ACTIVITY);</a>
<a name="ln259">    err_code |= app_comms_ble_uninit();</a>
<a name="ln260">    err_code |= app_comms_ble_init (true);</a>
<a name="ln261">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln262">}</a>
<a name="ln263"> </a>
<a name="ln264">/** @brief Callback when GATT is disconnected&quot; */</a>
<a name="ln265">#ifndef CEEDLING</a>
<a name="ln266">static</a>
<a name="ln267">#endif</a>
<a name="ln268">void on_gatt_disconnected_isr (void * p_data, size_t data_len)</a>
<a name="ln269">{</a>
<a name="ln270">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln271">    err_code |= ri_scheduler_event_put (p_data, (uint16_t) data_len,</a>
<a name="ln272">                                        &amp;handle_gatt_disconnected);</a>
<a name="ln273">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln274">}</a>
<a name="ln275"> </a>
<a name="ln276">/**</a>
<a name="ln277"> * @brief Callback when data is received via GATT</a>
<a name="ln278"> *</a>
<a name="ln279"> * Schedule handling incoming message and replying back via given function pointer.</a>
<a name="ln280"> */</a>
<a name="ln281">#ifndef CEEDLING</a>
<a name="ln282">static</a>
<a name="ln283">#endif</a>
<a name="ln284">void on_gatt_data_isr (void * p_data, size_t data_len)</a>
<a name="ln285">{</a>
<a name="ln286">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln287">    err_code |= ri_scheduler_event_put (p_data, (uint16_t) data_len, &amp;handle_gatt_data);</a>
<a name="ln288">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln289">}</a>
<a name="ln290"> </a>
<a name="ln291">static rd_status_t ble_name_string_create (char * const name_str, const size_t name_len)</a>
<a name="ln292">{</a>
<a name="ln293">    uint64_t radio_addr = 0;</a>
<a name="ln294">    rd_status_t err_code = ri_radio_address_get (&amp;radio_addr);</a>
<a name="ln295">    radio_addr &amp;= 0xFFFF;</a>
<a name="ln296">    snprintf (name_str, name_len, &quot;%s %04X&quot;, RB_BLE_NAME_STRING, (uint16_t) radio_addr);</a>
<a name="ln297">    return err_code;</a>
<a name="ln298">}</a>
<a name="ln299"> </a>
<a name="ln300">#endif //!&lt; if GATT ENABLED</a>
<a name="ln301"> </a>
<a name="ln302">#if APP_NFC_ENABLED</a>
<a name="ln303"> </a>
<a name="ln304">#ifndef CEEDLING</a>
<a name="ln305">static</a>
<a name="ln306">#endif</a>
<a name="ln307">void handle_nfc_connected (void * p_data, uint16_t data_len)</a>
<a name="ln308">{</a>
<a name="ln309">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln310">    // No action needed</a>
<a name="ln311">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln312">}</a>
<a name="ln313"> </a>
<a name="ln314">#ifndef CEEDLING</a>
<a name="ln315">static</a>
<a name="ln316">#endif</a>
<a name="ln317">void on_nfc_connected_isr (void * p_data, size_t data_len)</a>
<a name="ln318">{</a>
<a name="ln319">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln320">    config_setup_on_this_conn();</a>
<a name="ln321">    err_code |= ri_scheduler_event_put (p_data, (uint16_t) data_len, &amp;handle_nfc_connected);</a>
<a name="ln322">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln323">}</a>
<a name="ln324"> </a>
<a name="ln325">#ifndef CEEDLING</a>
<a name="ln326">static</a>
<a name="ln327">#endif</a>
<a name="ln328">void handle_nfc_disconnected (void * p_data, uint16_t data_len)</a>
<a name="ln329">{</a>
<a name="ln330">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln331">    err_code |= config_conn_end();</a>
<a name="ln332">    err_code |= app_comms_configure_next_enable();</a>
<a name="ln333">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln334">}</a>
<a name="ln335"> </a>
<a name="ln336">/** @brief Callback when NFC is disconnected&quot; */</a>
<a name="ln337">#ifndef CEEDLING</a>
<a name="ln338">static</a>
<a name="ln339">#endif</a>
<a name="ln340">void on_nfc_disconnected_isr (void * p_data, size_t data_len)</a>
<a name="ln341">{</a>
<a name="ln342">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln343">    err_code |= ri_scheduler_event_put (p_data, (uint16_t) data_len,</a>
<a name="ln344">                                        &amp;handle_nfc_disconnected);</a>
<a name="ln345">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln346">}</a>
<a name="ln347">#endif</a>
<a name="ln348"> </a>
<a name="ln349">rd_status_t app_comms_configure_next_enable (void)</a>
<a name="ln350">{</a>
<a name="ln351">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln352">    err_code |= app_comms_ble_uninit();</a>
<a name="ln353">    err_code |= app_comms_ble_init (false);</a>
<a name="ln354">    m_mode_ops.disable_config = 1;</a>
<a name="ln355">    err_code |= ri_timer_stop (m_comm_timer);</a>
<a name="ln356">    err_code |= ri_timer_start (m_comm_timer, APP_CONFIG_ENABLED_TIME_MS, &amp;m_mode_ops);</a>
<a name="ln357">    m_config_enabled_on_next_conn = true;</a>
<a name="ln358">    err_code |= app_led_activity_set (RB_LED_CONFIG_ENABLED);</a>
<a name="ln359">    return err_code;</a>
<a name="ln360">}</a>
<a name="ln361">#else</a>
<a name="ln362">rd_status_t app_comms_configure_next_enable (void)</a>
<a name="ln363">{</a>
<a name="ln364">    return RD_ERROR_NOT_ENABLED;</a>
<a name="ln365">}</a>
<a name="ln366">#endif //!&lt; APP_COMMS_BIDIR_ENABLED</a>
<a name="ln367"> </a>
<a name="ln368">/**</a>
<a name="ln369"> * @brief Initialize Device information data.</a>
<a name="ln370"> *</a>
<a name="ln371"> * @param[in] secure If true, security sensitive data will be NULL/0-length.</a>
<a name="ln372"> * @retval RD_SUCCESS necessary data was available and is printed on p_dis.</a>
<a name="ln373"> * @return Error code from driver in case some data cannot be printed.</a>
<a name="ln374"> */</a>
<a name="ln375">static rd_status_t dis_init (ri_comm_dis_init_t * const p_dis, const bool secure)</a>
<a name="ln376">{</a>
<a name="ln377">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln378">    memset (p_dis, 0, sizeof (ri_comm_dis_init_t));</a>
<a name="ln379">#if APP_COMMS_BIDIR_ENABLED</a>
<a name="ln380">    size_t name_idx = 0;</a>
<a name="ln381">    err_code |= rt_com_get_mac_str (p_dis-&gt;deviceaddr, sizeof (p_dis-&gt;deviceaddr));</a>
<a name="ln382"> </a>
<a name="ln383">    if (!secure)</a>
<a name="ln384">    {</a>
<a name="ln385">        err_code |= rt_com_get_id_str (p_dis-&gt;deviceid, sizeof (p_dis-&gt;deviceid));</a>
<a name="ln386">    }</a>
<a name="ln387"> </a>
<a name="ln388">    name_idx = snprintf (p_dis-&gt;fw_version, sizeof (p_dis-&gt;fw_version), APP_FW_NAME);</a>
<a name="ln389">    snprintf (p_dis-&gt;fw_version + name_idx,</a>
<a name="ln390">              sizeof (p_dis-&gt;fw_version) - name_idx,</a>
<a name="ln391">              APP_FW_VERSION);</a>
<a name="ln392">    snprintf (p_dis-&gt;hw_version, sizeof (p_dis-&gt;hw_version), &quot;Check PCB&quot;);</a>
<a name="ln393">    snprintf (p_dis-&gt;manufacturer, sizeof (p_dis-&gt;manufacturer), RB_MANUFACTURER_STRING);</a>
<a name="ln394">    snprintf (p_dis-&gt;model, sizeof (p_dis-&gt;model), RB_MODEL_STRING);</a>
<a name="ln395">#endif</a>
<a name="ln396">    return err_code;</a>
<a name="ln397">}</a>
<a name="ln398"> </a>
<a name="ln399">static rd_status_t nfc_init (ri_comm_dis_init_t * const p_dis)</a>
<a name="ln400">{</a>
<a name="ln401">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln402">#if APP_NFC_ENABLED</a>
<a name="ln403">    err_code |= rt_nfc_init (p_dis);</a>
<a name="ln404">    rt_nfc_set_on_connected_isr (&amp;on_nfc_connected_isr);</a>
<a name="ln405">    rt_nfc_set_on_disconn_isr (&amp;on_nfc_disconnected_isr);</a>
<a name="ln406">#endif</a>
<a name="ln407">    return err_code;</a>
<a name="ln408">}</a>
<a name="ln409"> </a>
<a name="ln410">#ifndef CEEDLING</a>
<a name="ln411">static</a>
<a name="ln412">#endif</a>
<a name="ln413">void comm_mode_change_isr (void * const p_context)</a>
<a name="ln414">{</a>
<a name="ln415">    mode_changes_t * const p_change = (mode_changes_t *) p_context;</a>
<a name="ln416"> </a>
<a name="ln417">    if (p_change-&gt;switch_to_normal)</a>
<a name="ln418">    {</a>
<a name="ln419">        app_comms_bleadv_send_count_set (1);</a>
<a name="ln420">        p_change-&gt;switch_to_normal = 0;</a>
<a name="ln421">    }</a>
<a name="ln422"> </a>
<a name="ln423">#if APP_COMMS_BIDIR_ENABLED</a>
<a name="ln424"> </a>
<a name="ln425">    if (p_change-&gt;disable_config)</a>
<a name="ln426">    {</a>
<a name="ln427">        enable_config_on_next_conn (false);</a>
<a name="ln428">        app_led_activity_set (RB_LED_ACTIVITY);</a>
<a name="ln429">        p_change-&gt;disable_config = 0;</a>
<a name="ln430">    }</a>
<a name="ln431"> </a>
<a name="ln432">#endif</a>
<a name="ln433">}</a>
<a name="ln434"> </a>
<a name="ln435">static rd_status_t adv_init (void)</a>
<a name="ln436">{</a>
<a name="ln437">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln438">#if APP_ADV_ENABLED</a>
<a name="ln439">    ri_radio_channels_t channels = {0};</a>
<a name="ln440">    channels.channel_37 = 1;</a>
<a name="ln441">    channels.channel_38 = 1;</a>
<a name="ln442">    channels.channel_39 = 1;</a>
<a name="ln443">    rt_adv_init_t adv_settings = {0};</a>
<a name="ln444">    adv_settings.adv_interval_ms = 100U;</a>
<a name="ln445">    adv_settings.adv_pwr_dbm = RB_TX_POWER_MAX;</a>
<a name="ln446">    adv_settings.channels = channels;</a>
<a name="ln447">    adv_settings.manufacturer_id = RB_BLE_MANUFACTURER_ID;</a>
<a name="ln448">    err_code |= rt_adv_init (&amp;adv_settings);</a>
<a name="ln449">    err_code |= ri_adv_type_set (NONCONNECTABLE_NONSCANNABLE);</a>
<a name="ln450">    app_comms_bleadv_send_count_set (initial_adv_send_count());</a>
<a name="ln451">    m_mode_ops.switch_to_normal = 1;</a>
<a name="ln452">    prepare_mode_change (&amp;m_mode_ops);</a>
<a name="ln453">#endif</a>
<a name="ln454">    return err_code;</a>
<a name="ln455">}</a>
<a name="ln456"> </a>
<a name="ln457">static rd_status_t gatt_init (const ri_comm_dis_init_t * const p_dis, const bool secure)</a>
<a name="ln458">{</a>
<a name="ln459">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln460">#if APP_GATT_ENABLED</a>
<a name="ln461">    char name[SCAN_RSP_NAME_MAX_LEN + 1] = {0};</a>
<a name="ln462">    ble_name_string_create (name, sizeof (name));</a>
<a name="ln463">    err_code |= rt_gatt_init (name);</a>
<a name="ln464"> </a>
<a name="ln465">    if (!secure)</a>
<a name="ln466">    {</a>
<a name="ln467">        err_code |= rt_gatt_dfu_init();</a>
<a name="ln468">    }</a>
<a name="ln469"> </a>
<a name="ln470">    err_code |= rt_gatt_dis_init (p_dis);</a>
<a name="ln471">    err_code |= rt_gatt_nus_init ();</a>
<a name="ln472">    rt_gatt_set_on_connected_isr (&amp;on_gatt_connected_isr);</a>
<a name="ln473">    rt_gatt_set_on_disconn_isr (&amp;on_gatt_disconnected_isr);</a>
<a name="ln474">    rt_gatt_set_on_received_isr (&amp;on_gatt_data_isr);</a>
<a name="ln475">    err_code |= rt_gatt_enable();</a>
<a name="ln476">#endif</a>
<a name="ln477">    return err_code;</a>
<a name="ln478">}</a>
<a name="ln479"> </a>
<a name="ln480">rd_status_t app_comms_init (const bool secure)</a>
<a name="ln481">{</a>
<a name="ln482">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln483">    err_code |= ri_radio_init (APP_MODULATION);</a>
<a name="ln484">    err_code |= ri_timer_create (&amp;m_comm_timer, RI_TIMER_MODE_SINGLE_SHOT,</a>
<a name="ln485">                                 &amp;comm_mode_change_isr);</a>
<a name="ln486"> </a>
<a name="ln487">    if (RD_SUCCESS == err_code)</a>
<a name="ln488">    {</a>
<a name="ln489">        if (!secure)</a>
<a name="ln490">        {</a>
<a name="ln491">            err_code |= app_comms_configure_next_enable();</a>
<a name="ln492">        }</a>
<a name="ln493"> </a>
<a name="ln494">        ri_comm_dis_init_t dis = {0};</a>
<a name="ln495">        err_code |= dis_init (&amp;dis, false);</a>
<a name="ln496">        err_code |= nfc_init (&amp;dis);</a>
<a name="ln497">        err_code |= adv_init();</a>
<a name="ln498">        err_code |= dis_init (&amp;dis, secure);</a>
<a name="ln499">        err_code |= gatt_init (&amp;dis, secure);</a>
<a name="ln500">    }</a>
<a name="ln501"> </a>
<a name="ln502">    return err_code;</a>
<a name="ln503">}</a>
<a name="ln504"> </a>
<a name="ln505">rd_status_t app_comms_ble_init (const bool secure)</a>
<a name="ln506">{</a>
<a name="ln507">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln508">    ri_comm_dis_init_t dis = {0};</a>
<a name="ln509">    err_code |= dis_init (&amp;dis, secure);</a>
<a name="ln510">    err_code |= adv_init();</a>
<a name="ln511">    err_code |= gatt_init (&amp;dis, secure);</a>
<a name="ln512">    ri_radio_activity_callback_set (&amp;app_sensor_vdd_measure_isr);</a>
<a name="ln513">    return err_code;</a>
<a name="ln514">}</a>
<a name="ln515"> </a>
<a name="ln516">rd_status_t app_comms_ble_uninit (void)</a>
<a name="ln517">{</a>
<a name="ln518">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln519">    err_code |= rt_adv_uninit();</a>
<a name="ln520">    err_code |= rt_gatt_uninit();</a>
<a name="ln521">    return err_code;</a>
<a name="ln522">}</a>
<a name="ln523"> </a>
<a name="ln524">rd_status_t app_comms_blocking_send (const ri_comm_xfer_fp_t reply_fp,</a>
<a name="ln525">                                     ri_comm_message_t * const msg)</a>
<a name="ln526">{</a>
<a name="ln527">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln528">    const uint64_t start = ri_rtc_millis();</a>
<a name="ln529"> </a>
<a name="ln530">    do</a>
<a name="ln531">    {</a>
<a name="ln532">        if (ri_rtc_millis() &gt; (start + BLOCKING_COMM_TIMEOUT_MS))</a>
<a name="ln533">        {</a>
<a name="ln534">            err_code |= RD_ERROR_TIMEOUT;</a>
<a name="ln535">        }</a>
<a name="ln536">        else</a>
<a name="ln537">        {</a>
<a name="ln538">            err_code = RD_SUCCESS;</a>
<a name="ln539">        }</a>
<a name="ln540"> </a>
<a name="ln541">        if (RD_SUCCESS == err_code)</a>
<a name="ln542">        {</a>
<a name="ln543">            err_code |= reply_fp (msg);</a>
<a name="ln544">        }</a>
<a name="ln545"> </a>
<a name="ln546">        if (RD_ERROR_NO_MEM == err_code)</a>
<a name="ln547">        {</a>
<a name="ln548">            ri_yield();</a>
<a name="ln549">        }</a>
<a name="ln550">    } while ( (RD_SUCCESS != err_code) &amp;&amp; ! (RD_ERROR_TIMEOUT &amp; err_code));</a>
<a name="ln551"> </a>
<a name="ln552">    return err_code;</a>
<a name="ln553">}</a>
<a name="ln554">/** @} */</a>

</code></pre>
<div class="balloon" rel="87"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="111"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '((1285U) / 100U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="113"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="115"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="113"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression '0 == num_sends' is always false.</p></div>
<div class="balloon" rel="120"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="120"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(255U) - 1' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="118"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression '(255U) == num_sends' is always false.</p></div>
<div class="balloon" rel="150"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="151"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="164"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="186"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2571/" target="_blank">V2571</a> Pointer to void should not be converted to a pointer to object. Consider inspecting the expression: '(uint8_t *) p_data'.</p></div>
<div class="balloon" rel="187"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'raw_message[(0U)]' expression should not be converted from the essential 'unsigned' type to the essential 're_type_t' type.</p></div>
<div class="balloon" rel="207"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2519/" target="_blank">V2519</a> The 'default' label should, besides a 'break' statement, contain either a statement or a comment.</p></div>
<div class="balloon" rel="229"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'data_len'.</p></div>
<div class="balloon" rel="229"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'p_data'.</p></div>
<div class="balloon" rel="243"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2009/" target="_blank">V2009</a> Consider rendering the 'p_data' pointer as a pointer to const.</p></div>
<div class="balloon" rel="258"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="252"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'data_len'.</p></div>
<div class="balloon" rel="252"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'p_data'.</p></div>
<div class="balloon" rel="268"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2009/" target="_blank">V2009</a> Consider rendering the 'p_data' pointer as a pointer to const.</p></div>
<div class="balloon" rel="284"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2009/" target="_blank">V2009</a> Consider rendering the 'p_data' pointer as a pointer to const.</p></div>
<div class="balloon" rel="295"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The right operand '0xFFFF' of the '&=' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="295"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '&=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="305"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'data_len'.</p></div>
<div class="balloon" rel="305"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'p_data'.</p></div>
<div class="balloon" rel="317"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2009/" target="_blank">V2009</a> Consider rendering the 'p_data' pointer as a pointer to const.</p></div>
<div class="balloon" rel="326"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'data_len'.</p></div>
<div class="balloon" rel="326"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'p_data'.</p></div>
<div class="balloon" rel="340"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2009/" target="_blank">V2009</a> Consider rendering the 'p_data' pointer as a pointer to const.</p></div>
<div class="balloon" rel="354"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="357"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="358"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="388"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'signed' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="388"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="389"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2562/" target="_blank">V2562</a> Expressions with pointer type should not be used in the '+', '-', '+=' and '-=' operations.</p></div>
<div class="balloon" rel="415"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2571/" target="_blank">V2571</a> Pointer to void should not be converted to a pointer to object. Consider inspecting the expression: '(mode_changes_t *) p_context'.</p></div>
<div class="balloon" rel="420"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="428"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="429"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="440"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="441"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="442"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="444"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '100U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="445"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'character' and 'signed'.</p></div>
<div class="balloon" rel="447"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="451"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="461"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="550"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The '((1U << 10U) & err_code)' operand of the '!' operator should not have the essential 'unsigned' type.</p></div>
<div class="balloon" rel="550"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2570/" target="_blank">V2570</a> Operands of the '!' operator should have bool essential type.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
